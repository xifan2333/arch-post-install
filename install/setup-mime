#!/bin/bash
# MIME Type Setup - Configure default applications
# Usage: setup-mime

set -e

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# Print functions
print_step() {
    echo -e "\n${BLUE}==>${NC} ${YELLOW}$1${NC}"
}

print_substep() {
    echo -e "  ${PURPLE}->${NC} $1"
}

print_success() {
    echo -e "${GREEN}[OK]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# Detect installed applications
detect_app() {
    local category="$1"
    shift
    local apps=("$@")

    for app in "${apps[@]}"; do
        if command -v "$app" &>/dev/null; then
            echo "$app"
            return 0
        fi
    done
    return 1
}

# Set default application for MIME types
set_mime_default() {
    local desktop_file="$1"
    shift
    local mime_types=("$@")

    for mime in "${mime_types[@]}"; do
        xdg-mime default "$desktop_file" "$mime" 2>/dev/null || true
    done
}

# Main setup function
setup_mime_types() {
    print_step "Setting up MIME type associations"

    # Check if xdg-utils is installed
    if ! command -v xdg-mime &>/dev/null; then
        print_error "xdg-utils is not installed"
        print_info "Install with: sudo pacman -S xdg-utils"
        exit 1
    fi

    # Image viewer - imv
    print_substep "Configuring image viewer"
    set_mime_default "imv.desktop" \
        "image/jpeg" "image/png" "image/gif" "image/webp" \
        "image/bmp" "image/tiff" "image/svg+xml"
    print_success "Image viewer: imv"

    # PDF reader - wpspdf
    print_substep "Configuring PDF reader"
    set_mime_default "wpspdf.desktop" "application/pdf"
    print_success "PDF reader: wpspdf"

    # Text editor - vscode
    print_substep "Configuring text editor"
    set_mime_default "code.desktop" \
        "text/plain" "text/x-shellscript" "text/x-python" \
        "text/x-csrc" "text/x-c++src" "text/x-makefile" \
        "application/x-shellscript" "application/json" \
        "text/markdown" "text/x-rust" "text/x-go"
    print_success "Text editor: vscode"

    # Video player - mpv
    print_substep "Configuring video player"
    set_mime_default "mpv.desktop" \
        "video/mp4" "video/x-matroska" "video/webm" "video/mpeg" \
        "video/x-msvideo" "video/quicktime"
    print_success "Video player: mpv"

    # Audio player - mpv
    print_substep "Configuring audio player"
    set_mime_default "mpv.desktop" \
        "audio/mpeg" "audio/flac" "audio/x-wav" "audio/ogg" \
        "audio/mp4" "audio/x-m4a"
    print_success "Audio player: mpv"

    # Web browser - google-chrome-stable
    print_substep "Configuring web browser"
    set_mime_default "google-chrome.desktop" \
        "text/html" "application/xhtml+xml" "x-scheme-handler/http" \
        "x-scheme-handler/https"
    print_success "Web browser: google-chrome-stable"

    # Archive manager - xarchiver
    print_substep "Configuring archive manager"
    set_mime_default "xarchiver.desktop" \
        "application/zip" "application/x-tar" "application/x-7z-compressed" \
        "application/x-rar" "application/gzip" "application/x-bzip2" \
        "application/x-xz" "application/x-compressed-tar"
    print_success "Archive manager: xarchiver"

    # File manager - pcmanfm
    print_substep "Configuring file manager"
    set_mime_default "pcmanfm.desktop" "inode/directory"
    print_success "File manager: pcmanfm"

    echo
    print_success "MIME type associations configured!"
    print_info "All applications are now set to their defaults"
}

# Show current associations
show_associations() {
    print_step "Current MIME type associations"

    echo -e "\n${BLUE}Images:${NC}"
    echo "  image/png:  $(xdg-mime query default image/png 2>/dev/null || echo 'not set')"
    echo "  image/jpeg: $(xdg-mime query default image/jpeg 2>/dev/null || echo 'not set')"

    echo -e "\n${BLUE}Documents:${NC}"
    echo "  application/pdf: $(xdg-mime query default application/pdf 2>/dev/null || echo 'not set')"
    echo "  text/plain:      $(xdg-mime query default text/plain 2>/dev/null || echo 'not set')"

    echo -e "\n${BLUE}Media:${NC}"
    echo "  video/mp4:  $(xdg-mime query default video/mp4 2>/dev/null || echo 'not set')"
    echo "  audio/mpeg: $(xdg-mime query default audio/mpeg 2>/dev/null || echo 'not set')"

    echo -e "\n${BLUE}Web:${NC}"
    echo "  text/html:            $(xdg-mime query default text/html 2>/dev/null || echo 'not set')"
    echo "  x-scheme-handler/http: $(xdg-mime query default x-scheme-handler/http 2>/dev/null || echo 'not set')"

    echo -e "\n${BLUE}Archives:${NC}"
    echo "  application/zip: $(xdg-mime query default application/zip 2>/dev/null || echo 'not set')"

    echo -e "\n${BLUE}Directories:${NC}"
    echo "  inode/directory: $(xdg-mime query default inode/directory 2>/dev/null || echo 'not set')"
}

# Show usage
usage() {
    echo "Usage: $0 [setup|show|help]"
    echo
    echo "Commands:"
    echo "  setup    Configure MIME type associations (default)"
    echo "  show     Show current MIME type associations"
    echo "  help     Show this help message"
    echo
    echo "This script automatically detects installed applications and"
    echo "configures appropriate MIME type associations."
    echo
    echo "Supported applications:"
    echo "  Images:   imv, feh, sxiv, nsxiv"
    echo "  PDF:      wpspdf, zathura, evince, okular"
    echo "  Text:     nvim, vim, nano"
    echo "  Video:    mpv, vlc"
    echo "  Audio:    mpv, vlc"
    echo "  Browser:  google-chrome-stable, firefox, chromium, brave"
    echo "  Archive:  xarchiver, file-roller"
    echo "  Files:    thunar, pcmanfm, nautilus"
}

# Main
main() {
    local command="${1:-setup}"

    case "$command" in
        setup)
            setup_mime_types
            ;;
        show)
            show_associations
            ;;
        -h|--help|help)
            usage
            ;;
        *)
            print_error "Unknown command: $command"
            echo
            usage
            exit 1
            ;;
    esac
}

main "$@"
