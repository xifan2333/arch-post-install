#!/bin/bash
# Noise Suppression Setup - Install and configure noise suppression for voice
# Usage: setup-noise-suppression [install|configure|remove|status|help]

set -e

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# Print functions
print_step() {
    echo -e "\n${BLUE}==>${NC} ${YELLOW}$1${NC}"
}

print_substep() {
    echo -e "  ${PURPLE}->${NC} $1"
}

print_success() {
    echo -e "${GREEN}[OK]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# Package name
PACKAGE="noise-suppression-for-voice"
CONFIG_DIR="$HOME/.config/pipewire/pipewire.conf.d"
CONFIG_FILE="$CONFIG_DIR/99-input-denoising.conf"

# Check if package is installed
is_installed() {
    pacman -Qi "$PACKAGE" &>/dev/null
}

# Check if PipeWire is running
is_pipewire_running() {
    systemctl --user is-active pipewire.service &>/dev/null
}

# Install the package
install_package() {
    print_step "Installing noise-suppression-for-voice"

    if is_installed; then
        print_warning "Package already installed"
        return 0
    fi

    print_substep "Installing via pacman"
    sudo pacman -S --needed --noconfirm "$PACKAGE"
    print_success "Package installed successfully"
}

# Configure PipeWire
configure_pipewire() {
    print_step "Configuring PipeWire noise suppression"

    # Check if PipeWire is running
    if ! is_pipewire_running; then
        print_warning "PipeWire is not running"
        print_info "This setup requires PipeWire audio server"
        read -p "Continue anyway? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            return 1
        fi
    fi

    # Create config directory
    print_substep "Creating configuration directory"
    mkdir -p "$CONFIG_DIR"
    print_success "Directory created: $CONFIG_DIR"

    # Find the LADSPA plugin path
    print_substep "Locating LADSPA plugin"
    local plugin_path=""

    # Get plugin path from package files
    plugin_path=$(pacman -Ql "$PACKAGE" 2>/dev/null | grep 'ladspa/librnnoise_ladspa.so$' | awk '{print $2}')

    # Fallback: try to find it manually
    if [ -z "$plugin_path" ] || [ ! -f "$plugin_path" ]; then
        plugin_path=$(find /usr -name "librnnoise_ladspa.so" 2>/dev/null | head -n 1)
    fi

    if [ -z "$plugin_path" ]; then
        print_error "LADSPA plugin not found"
        print_info "Make sure noise-suppression-for-voice is installed correctly"
        return 1
    fi

    print_success "Plugin found: $plugin_path"

    # Create configuration file
    print_substep "Creating PipeWire configuration"
    cat > "$CONFIG_FILE" << EOF
# Noise suppression configuration for PipeWire
# Auto-generated by setup-noise-suppression script

context.modules = [
{   name = libpipewire-module-filter-chain
    args = {
        node.description = "Noise Canceling source"
        media.name = "Noise Canceling source"
        filter.graph = {
            nodes = [
                {
                    type = ladspa
                    name = rnnoise
                    plugin = $plugin_path
                    label = noise_suppressor_stereo
                    control = {
                        "VAD Threshold (%)" = 50.0
                        "VAD Grace Period (ms)" = 200
                        "Retroactive VAD Grace (ms)" = 0
                    }
                }
            ]
        }
        capture.props = {
            node.name = "capture.rnnoise_source"
            node.passive = true
            audio.rate = 48000
        }
        playback.props = {
            node.name = "rnnoise_source"
            media.class = Audio/Source
            audio.rate = 48000
        }
    }
}
]
EOF

    print_success "Configuration file created: $CONFIG_FILE"

    # Restart PipeWire if it's running
    if is_pipewire_running; then
        print_substep "Restarting PipeWire service"
        systemctl restart --user pipewire.service
        sleep 2

        if is_pipewire_running; then
            print_success "PipeWire restarted successfully"
        else
            print_error "Failed to restart PipeWire"
            print_info "You may need to restart it manually: systemctl restart --user pipewire.service"
            return 1
        fi
    fi

    echo
    print_success "Noise suppression configured!"
    print_info "You should now see 'Noise Canceling Source' in your audio settings"
    print_info "Configure your applications to use this source for noise-free audio"
    print_warning "Important: Audio rate is set to 48000 Hz (required by the plugin)"
}

# Remove configuration
remove_config() {
    print_step "Removing noise suppression configuration"

    if [ -f "$CONFIG_FILE" ]; then
        rm "$CONFIG_FILE"
        print_success "Configuration file removed"

        if is_pipewire_running; then
            print_substep "Restarting PipeWire service"
            systemctl restart --user pipewire.service
            print_success "PipeWire restarted"
        fi
    else
        print_warning "Configuration file not found"
    fi
}

# Show status
show_status() {
    print_step "Noise suppression status"

    echo -e "\n${BLUE}Package:${NC}"
    if is_installed; then
        local version=$(pacman -Q "$PACKAGE" | awk '{print $2}')
        print_success "Installed (version: $version)"
    else
        print_error "Not installed"
    fi

    echo -e "\n${BLUE}Configuration:${NC}"
    if [ -f "$CONFIG_FILE" ]; then
        print_success "Configuration file exists"
        echo "  Location: $CONFIG_FILE"
    else
        print_warning "Configuration file not found"
    fi

    echo -e "\n${BLUE}PipeWire:${NC}"
    if is_pipewire_running; then
        print_success "Running"

        # Try to find the noise canceling source
        if command -v pw-cli &>/dev/null; then
            if pw-cli ls Node | grep -q "Noise Canceling Source"; then
                print_success "Noise Canceling Source is available"
            else
                print_warning "Noise Canceling Source not found in PipeWire"
            fi
        fi
    else
        print_warning "Not running"
    fi

    echo -e "\n${BLUE}Plugin:${NC}"
    local plugin_path=$(pacman -Ql "$PACKAGE" 2>/dev/null | grep 'ladspa/librnnoise_ladspa.so$' | awk '{print $2}')
    if [ -n "$plugin_path" ] && [ -f "$plugin_path" ]; then
        print_success "LADSPA plugin found"
        echo "  Location: $plugin_path"
    else
        print_warning "LADSPA plugin not found"
    fi
}

# Show usage
usage() {
    echo "Usage: $0 [install|configure|remove|status|help]"
    echo
    echo "Commands:"
    echo "  install    Install noise-suppression-for-voice package (default)"
    echo "  configure  Configure PipeWire to use noise suppression"
    echo "  remove     Remove noise suppression configuration"
    echo "  status     Show installation and configuration status"
    echo "  help       Show this help message"
    echo
    echo "Description:"
    echo "  This script installs and configures real-time noise suppression"
    echo "  for microphone input using RNNoise plugin with PipeWire."
    echo
    echo "Requirements:"
    echo "  - PipeWire audio server (>= 0.3.45)"
    echo "  - Audio sample rate: 48000 Hz (automatically configured)"
    echo
    echo "After installation:"
    echo "  1. Select 'Noise Canceling Source' as your audio input"
    echo "  2. Adjust VAD Threshold (50-95%) if needed"
    echo "  3. Test with your voice chat application"
    echo
    echo "Configuration file: $CONFIG_FILE"
}

# Main
main() {
    local command="${1:-install}"

    case "$command" in
        install)
            install_package
            echo
            print_info "Package installed. Run '$0 configure' to set up PipeWire"
            ;;
        configure)
            if ! is_installed; then
                print_error "Package not installed. Run '$0 install' first"
                exit 1
            fi
            configure_pipewire
            ;;
        remove)
            remove_config
            ;;
        status)
            show_status
            ;;
        -h|--help|help)
            usage
            ;;
        *)
            print_error "Unknown command: $command"
            echo
            usage
            exit 1
            ;;
    esac
}

main "$@"
