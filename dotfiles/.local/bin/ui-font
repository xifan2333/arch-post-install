#!/bin/bash
# Interactive font switcher with wmenu
# Usage: wfont

set -e

# Load wmenu common configuration
WMENU_LIB="$HOME/.local/lib/l-wmenu-common.sh"
if [ -f "$WMENU_LIB" ]; then
    . "$WMENU_LIB"
else
    echo "Error: wmenu common library not found" >&2
    exit 1
fi

# Auto-detect Nerd Font Mono fonts from system
get_nerd_fonts() {
    fc-list : family style | grep -i "nerd font mono" | cut -d: -f1 | cut -d, -f1 | sort -u
}

# Get available fonts
FONTS=$(get_nerd_fonts)

if [ -z "$FONTS" ]; then
    if command -v notify-send >/dev/null 2>&1; then
        notify-send "Font Switcher" "No Nerd Font Mono fonts found"
    fi
    echo "Error: No Nerd Font Mono fonts found"
    exit 1
fi

# Get current font
CURRENT_FONT=$(font-current 2>/dev/null || echo "")

# Mark current font in list
if [ -n "$CURRENT_FONT" ]; then
    FONTS=$(echo "$FONTS" | sed "s/^$CURRENT_FONT$/● $CURRENT_FONT/")
fi

# Show font menu
SELECTED=$(echo "$FONTS" | run_wmenu -p "Select font:")

# User cancelled
[ -z "$SELECTED" ] && exit 0

# Remove marker if present
FONT_NAME=$(echo "$SELECTED" | sed 's/^● //')

# Set the font using font-set
if font-set "$FONT_NAME"; then
    # Send notification
    if command -v notify-send >/dev/null 2>&1; then
        notify-send "Font Switcher" "Switched to: $FONT_NAME\n\n✓ Terminal config updated\n✓ Waybar restarted"
    fi
else
    if command -v notify-send >/dev/null 2>&1; then
        notify-send "Font switch failed" "Failed to set font: $FONT_NAME"
    fi
    exit 1
fi
