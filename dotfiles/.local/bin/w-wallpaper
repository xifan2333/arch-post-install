#!/bin/bash
# Wallpaper switcher with local and network (Bing) modes
# Usage: switch-wallpaper

set -e

# Wallpaper state file - stores current wallpaper path
WALLPAPER_STATE="$HOME/.config/current/wallpaper"

# Wallpaper directory - user's Pictures folder
XDG_PICTURES_DIR="${XDG_PICTURES_DIR:-$HOME/Pictures}"
WALLPAPER_DIR="$XDG_PICTURES_DIR/wallpapers"

# Load wmenu common configuration
WMENU_LIB="$HOME/.local/lib/l-wmenu-common.sh"
if [ -f "$WMENU_LIB" ]; then
    . "$WMENU_LIB"
else
    echo "Error: wmenu common library not found" >&2
    exit 1
fi

# Load i18n library
I18N_LIB="$HOME/.local/lib/l-i18n.sh"
if [ -f "$I18N_LIB" ]; then
    . "$I18N_LIB"
else
    echo "Error: i18n library not found" >&2
    exit 1
fi

# Ensure wallpaper directory exists
mkdir -p "$WALLPAPER_DIR"

# Notification helper
notify() {
    if command -v notify-send >/dev/null 2>&1; then
        notify-send "$(t "wallpaper.title")" "$1"
    fi
}

# Set wallpaper using swaybg (Wayland)
set_wallpaper() {
    local wallpaper="$1"

    # Kill existing swaybg
    pkill swaybg 2>/dev/null || true

    # Start new swaybg in background
    swaybg -i "$wallpaper" -m fill &

    # Save wallpaper path to state file
    mkdir -p "$(dirname "$WALLPAPER_STATE")"
    echo "$wallpaper" > "$WALLPAPER_STATE"

    echo "Wallpaper set to: $wallpaper"
}

# Download Bing daily wallpaper
download_bing_wallpaper() {
    echo "Downloading Bing daily wallpaper..."

    # Bing wallpaper API
    BING_API="https://bing.img.run/rand.php"

    # Use fixed filename to avoid file redundancy (overwrite on each download)
    FILENAME="bing.jpg"
    WALLPAPER_PATH="$WALLPAPER_DIR/$FILENAME"

    # Download wallpaper (overwrite if exists)
    if curl -L -s -o "$WALLPAPER_PATH" "$BING_API"; then
        echo "Downloaded: $WALLPAPER_PATH"
    else
        notify "$(t "wallpaper.bing_error")"
        echo "Error: Failed to download Bing wallpaper" >&2
        exit 1
    fi

    # Set as wallpaper
    set_wallpaper "$WALLPAPER_PATH"
    notify "$(t "wallpaper.bing_success")"
}

# Select wallpaper from local directory
select_local_wallpaper() {
    # Find all image files in wallpaper directory
    local images=$(find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) -printf "%f\n" | sort)

    if [ -z "$images" ]; then
        notify "$(t "wallpaper.not_found")"
        echo "Error: No wallpapers found in $WALLPAPER_DIR" >&2
        exit 1
    fi

    # Show selection menu
    local selected=$(echo "$images" | run_wmenu -p "$(t "wallpaper.select_prompt")")

    # User cancelled
    [ -z "$selected" ] && exit 0

    # Set wallpaper
    WALLPAPER_PATH="$WALLPAPER_DIR/$selected"
    set_wallpaper "$WALLPAPER_PATH"
    notify "$(t "wallpaper.set_success" "$selected")"
}

# Main menu
MODE=$(printf "$(t "wallpaper.local")\n$(t "wallpaper.bing")" | run_wmenu -p "$(t "wallpaper.mode_prompt")")

# User cancelled
[ -z "$MODE" ] && exit 0

case "$MODE" in
    "$(t "wallpaper.local")")
        select_local_wallpaper
        ;;
    "$(t "wallpaper.bing")")
        download_bing_wallpaper
        ;;
    *)
        echo "Invalid mode" >&2
        exit 1
        ;;
esac
