#!/bin/bash
# Sync fcitx5 theme based on current theme
# This script is called by w-theme when switching themes

set -e

CURRENT_LINK="$HOME/.config/current"
FCITX5_THEME_DIR="$HOME/.local/share/fcitx5/themes/custom"
FCITX5_CLASSICUI="$HOME/.config/fcitx5/conf/classicui.conf"

# Get current theme path
if [ ! -L "$CURRENT_LINK" ]; then
    echo "No current theme set" >&2
    exit 1
fi

CURRENT_THEME_DIR=$(readlink -f "$CURRENT_LINK")
FCITX5_CONF="$CURRENT_THEME_DIR/fcitx5.conf"

# Check if theme has fcitx5 config
if [ ! -f "$FCITX5_CONF" ]; then
    echo "Warning: Current theme has no fcitx5.conf, skipping fcitx5 sync"
    exit 0
fi

# Create fcitx5 theme directory
mkdir -p "$FCITX5_THEME_DIR"

# Copy theme config to custom theme directory
cp "$FCITX5_CONF" "$FCITX5_THEME_DIR/theme.conf"

# Create or update classicui.conf to use custom theme
mkdir -p "$(dirname "$FCITX5_CLASSICUI")"
cat > "$FCITX5_CLASSICUI" <<EOF
# Vertical Candidate List
Vertical Candidate List=False

# Font
Font="Sans 12"

# Theme
Theme=custom
EOF

echo "fcitx5 theme updated"

# Restart fcitx5 to apply theme changes
if pgrep -x fcitx5 >/dev/null; then
    killall fcitx5
    # Wait a moment for fcitx5 to exit
    sleep 0.5
    # Start fcitx5 in background
    # Check if running in River WM
    if command -v riverctl >/dev/null 2>&1 && pgrep -x river >/dev/null 2>&1; then
        riverctl spawn fcitx5 &
        echo "fcitx5 restarted (via riverctl)"
    else
        nohup fcitx5 >/dev/null 2>&1 &
        echo "fcitx5 restarted"
    fi
fi
