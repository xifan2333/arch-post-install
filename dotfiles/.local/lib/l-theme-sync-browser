#!/bin/bash
# Sync browser theme color with current system theme
# Note: This requires root access to write to browser policy directories

set -e

BROWSER_THEME_FILE="$HOME/.config/current/chromium.theme"

# Check if theme has browser color configuration
if [ ! -f "$BROWSER_THEME_FILE" ]; then
    echo "No browser theme color defined for this theme"
    exit 0
fi

# Read RGB values from theme file
RGB=$(<"$BROWSER_THEME_FILE")

# Convert RGB to hex color
THEME_HEX_COLOR=$(printf '#%02x%02x%02x' ${RGB//,/ })

# Function to set browser theme
set_browser_theme() {
    local browser="$1"
    local policy_dir="$2"

    if ! command -v "$browser" >/dev/null 2>&1; then
        return 0
    fi

    # Check if we have write access to policy directory
    if [ ! -w "$policy_dir" ] && [ ! -d "$policy_dir" ]; then
        echo "Warning: Cannot write to $policy_dir (need sudo)"
        return 1
    fi

    # Create policy directory if it doesn't exist
    sudo mkdir -p "$policy_dir" 2>/dev/null || true

    # Write browser theme policy
    echo "{\"BrowserThemeColor\": \"$THEME_HEX_COLOR\"}" | \
        sudo tee "$policy_dir/color.json" >/dev/null 2>&1 || {
        echo "Warning: Failed to set $browser theme (need sudo)"
        return 1
    }

    # Refresh browser policy
    "$browser" --refresh-platform-policy --no-startup-window >/dev/null 2>&1 &

    echo "$browser theme color set to $THEME_HEX_COLOR"
}

# Set theme for available browsers
set_browser_theme "chromium" "/etc/chromium/policies/managed"
set_browser_theme "brave" "/etc/brave/policies/managed"
set_browser_theme "google-chrome" "/etc/opt/chrome/policies/managed"

echo "Browser themes synced (if available)"
