#!/bin/bash
# Screen recording library - shared functions
# Source this file in screen recording scripts

# XDG directories
XDG_VIDEOS_DIR="${XDG_VIDEOS_DIR:-$HOME/Videos}"
RECORDINGS_DIR="$XDG_VIDEOS_DIR/screenrecords"
PID_FILE="/tmp/wf-recorder.pid"

# Recording settings for kdenlive compatibility
FRAMERATE="30"              # CFR - Constant Frame Rate for kdenlive (30fps perfect for tutorials)
CODEC="libx264"             # H.264 codec
PRESET="medium"             # Encoding preset (medium is good balance for recording)
CRF="20"                    # Quality (18-28, lower = better quality) - 20 for clear text/UI
AUDIO_SOURCE="rnnoise_source"  # Noise-suppressed audio source

# Ensure directories exist
mkdir -p "$RECORDINGS_DIR"

# Generate filename with timestamp
screenrecord_filename() {
    echo "screenrecord-$(date +%Y%m%d_%H%M%S).mp4"
}

# Check dependencies
screenrecord_check_deps() {
    for cmd in wf-recorder slurp; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            echo "Error: $cmd is not installed" >&2
            exit 1
        fi
    done
}

# Check if recording is active
screenrecord_is_active() {
    [ -f "$PID_FILE" ] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null
}

# Notify waybar to update screenrecord module
screenrecord_notify_waybar() {
    pkill -SIGRTMIN+8 waybar 2>/dev/null || true
}

# Waybar module: output status JSON
screenrecord_waybar_status() {
    # Load i18n for tooltips
    source "$HOME/.local/lib/lib-ui-i18n"

    if screenrecord_is_active; then
        # Get recording start time from PID file modification time
        start_time=$(stat -c %Y "$PID_FILE" 2>/dev/null || echo 0)
        current_time=$(date +%s)
        duration=$((current_time - start_time))

        # Format duration as MM:SS
        minutes=$((duration / 60))
        seconds=$((duration % 60))
        time_str=$(printf "%02d:%02d" $minutes $seconds)

        # Output JSON for waybar
        tooltip=$(msg "waybar_screenrecord_tooltip_recording")
        echo "{\"text\":\"$time_str\",\"alt\":\"recording\",\"class\":\"recording\",\"tooltip\":\"$tooltip\"}"
    else
        # Not recording
        tooltip=$(msg "waybar_screenrecord_tooltip_idle")
        echo "{\"text\":\"\",\"alt\":\"idle\",\"class\":\"idle\",\"tooltip\":\"$tooltip\"}"
    fi
}

# Waybar module: handle click event
screenrecord_waybar_click() {
    if screenrecord_is_active; then
        # Currently recording - stop it
        screenrecord-stop
    else
        # Not recording - show menu to start
        ui-screenrecord
    fi
}

