#!/bin/sh
# River autostart programs

# Restart on every reload (kill managed services)
killall -q waybar swaybg fcitx5 dunst swayidle

# Note: UWSM handles systemd environment import automatically
# No need to manually import WAYLAND_DISPLAY, XDG_CURRENT_DESKTOP, etc.

# Status bar - managed by uwsm
uwsm app -- waybar &

# Input method - managed by uwsm
uwsm app -- fcitx5 -d &

# Notification daemon - managed by uwsm
uwsm app -- dunst &

# Idle manager (screensaver,dpms) - managed by uwsm
uwsm app -- idle-manager 600 1800 &

# Wallpaper - restore from saved state
if command -v swaybg >/dev/null 2>&1; then
    WALLPAPER_STATE="${XDG_CONFIG_HOME:-$HOME/.config}/current/wallpaper"
    if [ -f "$WALLPAPER_STATE" ] && [ -s "$WALLPAPER_STATE" ]; then
        WALLPAPER_PATH=$(cat "$WALLPAPER_STATE")
        if [ -f "$WALLPAPER_PATH" ]; then
            uwsm app -- swaybg -i "$WALLPAPER_PATH" -m fill &
        else
            # Fallback to solid color if saved wallpaper doesn't exist
            uwsm app -- swaybg -c '#1d2021' &
        fi
    else
        # No saved wallpaper, use solid color
        uwsm app -- swaybg -c '#1d2021' &
    fi
fi

# Clipboard history manager - managed by uwsm
uwsm app -- wl-paste --type text --watch cliphist store &
uwsm app -- wl-paste --type image --watch cliphist store &

# Polkit authentication agent
pgrep 'polkit-gnome' || riverctl spawn "/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1" &

# Network manager applet
pgrep 'nm-applet' || uwsm app -- nm-applet --indicator &

# Bluetooth tray
pgrep 'blueman-applet' || uwsm app -- blueman-applet &

# Layout generator - NOT managed by uwsm (river-specific)
riverctl spawn rivertile

# Auto-lock on startup (for seamless login security)
(sleep 2 && uwsm app -- screen-lock) &
