#!/bin/bash
# Interactive theme switcher with wmenu
# Usage: switch-theme

set -e

THEME_DIR="$HOME/.config/theme/themes"
CONFIG_DIR="$HOME/.config/theme"

# Load wmenu common configuration
WMENU_LIB="$HOME/.local/lib/wmenu-common.sh"
if [ -f "$WMENU_LIB" ]; then
    . "$WMENU_LIB"
    load_theme_colors
else
    # Fallback: load current theme colors
    if [ -f "$CONFIG_DIR/colors.sh" ]; then
        . "$CONFIG_DIR/colors.sh"
    fi
fi

# Get current theme
CURRENT_THEME=""
if [ -L "$CONFIG_DIR/colors.sh" ]; then
    CURRENT_THEME=$(basename "$(readlink "$CONFIG_DIR/colors.sh")" .sh)
fi

# Get available themes with current theme marked
get_themes() {
    for theme in "$THEME_DIR"/*.sh; do
        name=$(basename "$theme" .sh)
        if [ "$name" = "$CURRENT_THEME" ]; then
            echo "● $name"
        else
            echo "  $name"
        fi
    done
}

# Function to apply theme to foot terminal
apply_theme_to_foot() {
    # Use dotfiles directory if available, otherwise use actual config
    if [ -d "$HOME/.dotfiles/foot/.config/foot" ]; then
        FOOT_COLORS="$HOME/.dotfiles/foot/.config/foot/colors.ini"
    else
        FOOT_COLORS="$HOME/.config/foot/colors.ini"
    fi

    # Load theme colors
    if [ -f "$CONFIG_DIR/colors.sh" ]; then
        . "$CONFIG_DIR/colors.sh"
    else
        echo "Error: Theme config not found" >&2
        return 1
    fi

    # Generate foot colors.ini
    cat > "$FOOT_COLORS" << EOF
# Auto-generated by switch-theme
# Do not edit manually - changes will be overwritten

[colors]
foreground=${COLOR_FG0#\#}
background=${COLOR_BG0#\#}

## Normal colors
regular0=${COLOR_BLACK#\#}
regular1=${COLOR_RED#\#}
regular2=${COLOR_GREEN#\#}
regular3=${COLOR_YELLOW#\#}
regular4=${COLOR_BLUE#\#}
regular5=${COLOR_PURPLE#\#}
regular6=${COLOR_CYAN#\#}
regular7=${COLOR_FG0#\#}

## Bright colors
bright0=${COLOR_BG3#\#}
bright1=${COLOR_RED#\#}
bright2=${COLOR_GREEN#\#}
bright3=${COLOR_YELLOW#\#}
bright4=${COLOR_BLUE#\#}
bright5=${COLOR_PURPLE#\#}
bright6=${COLOR_CYAN#\#}
bright7=${COLOR_FG1#\#}

## Selection colors
selection-foreground=${COLOR_BG0#\#}
selection-background=${COLOR_BLUE#\#}

## URLs
urls=${COLOR_BLUE#\#}
EOF

    echo "Foot colors updated to match current theme"
}

# Show wmenu selector with theme colors
SELECTED=$(get_themes | wmenu -p "选择主题:" \
    -f "${WMENU_FONT:-Noto Sans CJK SC 13}" \
    -N "${COLOR_BG0#\#}" \
    -n "${COLOR_FG0#\#}" \
    -M "${COLOR_BLUE#\#}" \
    -m "${COLOR_BG0#\#}" \
    -S "${COLOR_GREEN#\#}" \
    -s "${COLOR_BG0#\#}")

# User cancelled
[ -z "$SELECTED" ] && exit 0

# Extract theme name (remove marker if present)
THEME_NAME=$(echo "$SELECTED" | sed 's/^[●  ]*//')

# Create symbolic links
ln -sf "themes/${THEME_NAME}.sh" "$CONFIG_DIR/colors.sh"
ln -sf "themes/${THEME_NAME}.css" "$CONFIG_DIR/colors.css"

# Apply theme to foot terminal
apply_theme_to_foot

# Send notification
if command -v notify-send >/dev/null 2>&1; then
    notify-send "主题切换" "已切换到: ${THEME_NAME}\n打开新终端以查看效果"
fi
