#!/bin/bash
# Interactive theme switcher with wofi
# Usage: ui-theme

set -e

# Load i18n
source i18n-core

THEMES_DIR="$HOME/.config/themes"
CURRENT_LINK="$HOME/.config/current"

# Get current theme name
get_current_theme() {
    if [ -L "$CURRENT_LINK" ]; then
        basename "$(readlink "$CURRENT_LINK")"
    else
        echo ""
    fi
}

CURRENT_THEME=$(get_current_theme)

# Get available themes with current theme marked
get_themes() {
    for theme_dir in "$THEMES_DIR"/*; do
        [ -d "$theme_dir" ] || continue
        theme_name=$(basename "$theme_dir")
        if [ "$theme_name" = "$CURRENT_THEME" ]; then
            echo "${i18n[current_marker]} $theme_name"
        else
            echo "  $theme_name"
        fi
    done
}

# Show wofi selector
SELECTED=$(get_themes | ui-wofi --dmenu -p "${i18n[theme_prompt]}")

# User cancelled
[ -z "$SELECTED" ] && exit 0

# Extract theme name (remove marker if present)
THEME_NAME=$(echo "$SELECTED" | sed "s/^[${i18n[current_marker]}  ]*//")
THEME_PATH="$THEMES_DIR/$THEME_NAME"

# Check if theme exists
if [ ! -d "$THEME_PATH" ]; then
    echo "$(msg theme_error_not_found theme "$THEME_NAME" path "$THEME_PATH")" >&2
    exit 1
fi

# Update symlink to current theme
ln -nsf "themes/$THEME_NAME" "$CURRENT_LINK"

# Reload applications to apply theme
reload_apps() {
    # Sync GTK color scheme (light/dark mode)
    if command -v theme-sync-gtk >/dev/null 2>&1; then
        theme-sync-gtk
    fi

    # Reload waybar
    if pgrep -x waybar >/dev/null; then
        killall waybar
        riverctl spawn waybar &
    fi

    # Kill wofi if running (will use new theme on next launch)
    if pgrep -x wofi >/dev/null; then
        pkill -x wofi
    fi

    # Sync terminal emulator theme
    if command -v theme-sync-terminal >/dev/null 2>&1; then
        theme-sync-terminal
    fi

    # Sync VSCode theme
    if command -v theme-sync-vscode >/dev/null 2>&1; then
        theme-sync-vscode
    fi

    # Sync eza (ls) theme
    if command -v theme-sync-eza >/dev/null 2>&1; then
        theme-sync-eza
    fi

    # Restart dunst to apply new theme
    if pgrep -x dunst >/dev/null; then
        killall dunst
        riverctl spawn dunst &
    fi

    # Sync btop theme
    if command -v theme-sync-btop >/dev/null 2>&1; then
        theme-sync-btop
    fi

    # Sync fcitx5 theme
    if command -v theme-sync-fcitx5 >/dev/null 2>&1; then
        theme-sync-fcitx5
    fi

    # Sync swaylock theme
    if command -v theme-sync-swaylock >/dev/null 2>&1; then
        theme-sync-swaylock
    fi

    # Apply River WM border colors
    if [ -f "$THEME_PATH/riverrc" ]; then
        . "$THEME_PATH/riverrc"
        riverctl border-color-focused "${RIVER_BORDER_FOCUSED:-0x61afefff}"
        riverctl border-color-unfocused "${RIVER_BORDER_UNFOCUSED:-0x4b5263ff}"
    fi
}

reload_apps

# Send notification
if command -v notify-send >/dev/null 2>&1; then
    notify-send -i preferences-desktop-theme "${i18n[theme_title]}" "$(msg theme_switched_notify theme "$THEME_NAME")"
fi
