#!/bin/bash
# Screen recording library - shared functions
# Source this file in screen recording scripts

# XDG directories
XDG_VIDEOS_DIR="${XDG_VIDEOS_DIR:-$(xdg-user-dir VIDEOS)}"
RECORDINGS_DIR="$XDG_VIDEOS_DIR/screenrecords"
PID_FILE="/tmp/wf-recorder.pid"

# Recording settings (minimal - use wf-recorder defaults)
AUDIO_SOURCE="rnnoise_source"  # Noise-suppressed audio source

# YouTube-standard transcode settings (高质量转码，符合社交媒体标准)
AUTO_TRANSCODE="true"       # Auto-transcode to true CFR after recording stops (set to "false" to disable)
FRAMERATE="30"              # Target framerate for transcode
TRANSCODE_CRF="15"          # CRF 15 = near-lossless (lower than 18 for better quality after re-encode)
TRANSCODE_PRESET="slow"     # slow = better quality compression (YouTube recommended)
TRANSCODE_PROFILE="high"    # High Profile Level 4.0 (YouTube recommended)
TRANSCODE_LEVEL="4.0"       # H.264 Level 4.0 (supports 1080p30)
PIXEL_FORMAT="yuv420p"      # Standard pixel format for kdenlive compatibility
GOP_SIZE="60"               # Keyframe interval (2 seconds at 30fps) for better seeking in kdenlive
B_FRAMES="2"                # B-frames for better compression

# Ensure directories exist
mkdir -p "$RECORDINGS_DIR"

# Generate filename with timestamp
screenrecord_filename() {
    echo "screenrecord-$(date +%Y%m%d_%H%M%S).mp4"
}

# Check dependencies
screenrecord_check_deps() {
    for cmd in wf-recorder slurp; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            echo "Error: $cmd is not installed" >&2
            exit 1
        fi
    done
}

# Check if recording is active
screenrecord_is_active() {
    [ -f "$PID_FILE" ] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null
}

# Notify waybar to update screenrecord module
screenrecord_notify_waybar() {
    pkill -SIGRTMIN+8 waybar 2>/dev/null || true
}

# Waybar module: output status JSON
screenrecord_waybar_status() {
    # Load i18n for tooltips
    source i18n-core

    if screenrecord_is_active; then
        # Get recording start time from PID file modification time
        start_time=$(stat -c %Y "$PID_FILE" 2>/dev/null || echo 0)
        current_time=$(date +%s)
        duration=$((current_time - start_time))

        # Format duration as MM:SS
        minutes=$((duration / 60))
        seconds=$((duration % 60))
        time_str=$(printf "%02d:%02d" $minutes $seconds)

        # Output JSON for waybar
        tooltip=$(msg "waybar_screenrecord_tooltip_recording")
        echo "{\"text\":\"$time_str\",\"alt\":\"recording\",\"class\":\"recording\",\"tooltip\":\"$tooltip\"}"
    else
        # Not recording
        tooltip=$(msg "waybar_screenrecord_tooltip_idle")
        echo "{\"text\":\"\",\"alt\":\"idle\",\"class\":\"idle\",\"tooltip\":\"$tooltip\"}"
    fi
}


screenrecord_waybar_click() {
    if screenrecord_is_active; then
        screenrecord-stop
    else
        screenrecord-start-full
    fi
}
