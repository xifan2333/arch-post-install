#!/bin/bash
# Screensaver for River WM using tte (Terminal Text Effects)
# Adapted from omarchy screensaver for River WM

LOGO_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/logo.txt"
SCREENSAVER_PID_FILE="/tmp/screensaver-$USER.pid"

screensaver_is_running() {
  [ -f "$SCREENSAVER_PID_FILE" ] && kill -0 "$(cat "$SCREENSAVER_PID_FILE")" 2>/dev/null
}

exit_screensaver() {
  pkill -x tte 2>/dev/null
  pkill -f "alacritty.*--class Screensaver" 2>/dev/null
  rm -f "$SCREENSAVER_PID_FILE"
  exit 0
}

# Check if already running
if screensaver_is_running; then
  exit 0
fi

# Save PID
echo $$ > "$SCREENSAVER_PID_FILE"

trap exit_screensaver SIGINT SIGTERM SIGHUP SIGQUIT

# Check if logo file exists
if [ ! -f "$LOGO_FILE" ]; then
  echo "Error: Logo file not found at $LOGO_FILE"
  exit 1
fi

# Launch fullscreen terminal with tte animation
alacritty --class Screensaver \
  -e bash -c '
  LOGO_FILE="'"$LOGO_FILE"'"

  while true; do
    # Get random effect from tte
    effect=$(tte 2>&1 | grep -oP "{\K[^}]+" | tr "," " " | tr " " "\n" | sed -n "/^beams$/,\$p" | sort -u | shuf -n1)

    # Run tte with random effect
    tte -i "$LOGO_FILE" \
      --frame-rate 240 \
      --canvas-width 0 \
      --canvas-height $(($(tput lines) - 2)) \
      --anchor-canvas c \
      --anchor-text c \
      "$effect" 2>/dev/null

    # Small delay between effects
    sleep 1
  done
' &

# Wait for screensaver to exit
wait
exit_screensaver
